name: Integration Doc Generator

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Branch in appsmith-docs to create PR against'
        required: true
        default: 'main'
        type: string

jobs:
  generate_docs:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout the docs repo at the target branch
      - name: Checkout appsmith-docs
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          ref: ${{ github.event.inputs.target_branch }}
          fetch-depth: 0

      # 2. Checkout the integration-resources repo
      - name: Checkout integration-resources
        uses: actions/checkout@v4
        with:
          repository: appsmithorg/integration-resources
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          ref: main
          path: integration-resources
          fetch-depth: 10

      # 3. Identify files committed in the last 7 days
      - name: Detect recent UQI config files
        id: detect
        run: |
          mkdir -p scripts
          # List all UQI configs changed in the last 7 days
          cd integration-resources
          git fetch --depth=10 origin main
          git log origin/main --since="7 days ago" --pretty=format: --name-only \
            | grep 'Generic UQI Creation/uqi_configs/.*_uqi_config.json' \
            | sort -u > ../scripts/files_to_process.txt
          cd ..
          echo "Files to process:"
          cat scripts/files_to_process.txt || echo "(none)"
          if [ ! -s scripts/files_to_process.txt ]; then
            echo "❌ No files changed in the last 7 days. Exiting."
            exit 0
          fi
          echo "changes_found=true" >> $GITHUB_ENV

      # 4. Process each file with OpenAI
      - name: Generate docs with OpenAI
        if: env.changes_found == 'true'
        run: |
          mkdir -p website/docs/connect-data/reference
          PROCESSED=0
          while IFS= read -r FILE_PATH; do
            echo "⏳ Processing $FILE_PATH"
            # URL-encode spaces
            URL_PATH=$(echo "$FILE_PATH" | sed 's/ /%20/g')
            RAW_URL="https://raw.githubusercontent.com/appsmithorg/integration-resources/main/$URL_PATH"

            echo "Fetching $RAW_URL"
            curl -fsSL --max-time 60 "$RAW_URL" -o input.json || {
              echo "❌ Failed to fetch $FILE_PATH"
              continue
            }

            # Step 1: extract
            SYSTEM1=$(< .github/prompts/extract_prompt.txt)
            USER1=$(< input.json)
            PAYLOAD1=$(jq -nc \
              --arg sys "$SYSTEM1" \
              --arg usr "$USER1" \
              '{model:"gpt-4-1106-preview", messages:[{role:"system",content:$sys},{role:"user",content:$usr}], max_tokens:2000, temperature:0}')
            RESP1=$(curl -s -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
                         -H "Content-Type: application/json" \
                         -d "$PAYLOAD1" \
                         https://api.openai.com/v1/chat/completions)
            echo "$RESP1" | jq .
            EXTRACTED=$(echo "$RESP1" | jq -r '.choices[0].message.content')

            # Step 2: generate
            SYSTEM2=$(< .github/prompts/generate_prompt.txt)
            PAYLOAD2=$(jq -nc \
              --arg sys "$SYSTEM2" \
              --arg usr "$EXTRACTED" \
              '{model:"gpt-4-1106-preview", messages:[{role:"system",content:$sys},{role:"user",content:$usr}], max_tokens:4000, temperature:0.3}')
            RESP2=$(curl -s -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
                         -H "Content-Type: application/json" \
                         -d "$PAYLOAD2" \
                         https://api.openai.com/v1/chat/completions)
            echo "$RESP2" | jq .
            MD=$(echo "$RESP2" | jq -r '.choices[0].message.content')

            # Write out doc
            NAME=$(basename "$FILE_PATH" "_uqi_config.json" | tr '[:upper:]' '[:lower:]')
            OUT="website/docs/connect-data/reference/${NAME}.md"
            echo "$MD" > "$OUT"
            echo "✅ Wrote $OUT"

            # Track
            echo "$FILE_PATH" >> scripts/processed_files.txt
            PROCESSED=$((PROCESSED+1))
          done < scripts/files_to_process.txt

          echo "processed_count=$PROCESSED" >> $GITHUB_ENV
          if [ "$PROCESSED" -eq 0 ]; then
            echo "❌ No docs generated, exiting."
            exit 1
          fi
          echo "content_generated=true" >> $GITHUB_ENV

      # 5. Commit & open PR
      - name: Commit and create PR
        if: env.content_generated == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          title: "docs: update integration docs (recent changes)"
          commit-message: |
            docs: generate docs for recent UQI configs

            Processed files from the last 7 days.
          branch: "docs-update/${{ github.event.inputs.target_branch }}-${{ github.run_id }}"
          base: ${{ github.event.inputs.target_branch }}
          add-paths: |
            website/docs/connect-data/reference/
            scripts/processed_files.txt
          body: |
            This PR updates documentation for UQI configs changed in the last 7 days.
